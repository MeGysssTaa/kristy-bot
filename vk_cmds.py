import re

import groupsmgr
import timetable

# –ó–∞–ø—Ä–µ—â–µ–Ω–æ —Å–æ–∑–¥–∞–≤–∞—Ç—å –≥—Ä—É–ø–ø—ã —Å —ç—Ç–∏–º–∏ –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏.
FORBIDDEN_NAMES = ['all', '–≤—Å–µ', 'online', '–æ–Ω–ª–∞–π–Ω', '–∑–¥–µ—Å—å', 'here', '—Ç—É—Ç']
# –ø–æ–∫–∞ —Ç–∞–∫, –¥–∞–ª—å—à–µ –±—É–¥–µ—Ç –ª—É—á—à–µ
RANK_KING = 2
RANK_ADMIN = 1
RANK_HOLOP = 0


def exec_next_class(cmd, chat, peer, sender):
    """
    !–ø–∞—Ä–∞
    """
    sender_groups = groupsmgr.get_user_groups(chat, sender)
    next_class = timetable.next_class(chat, sender_groups)

    if next_class is None:
        cmd.send(peer, 'üö´ –ù–∞ —Å–µ–≥–æ–¥–Ω—è –≤—Å—ë. –ò–¥–∏ –ø–æ—Å–ø–∏, —á—Ç–æ –ª–∏.')
    else:
        class_data = next_class[0]
        time_left = timetable.time_left(next_class[1])
        cmd.send(peer, 'üìö –°–ª–µ–¥—É—é—â–∞—è –ø–∞—Ä–∞: %s. –î–æ –Ω–∞—á–∞–ª–∞ %s.' % (class_data, time_left))


def exec_create(cmd, chat, peer, sender, args):
    """
    !—Å–æ–∑–¥–∞—Ç—å
    """
    existing = groupsmgr.get_all_groups(chat)

    created = []
    bad_names = []
    already_existed = []

    for group in args:
        if 2 <= len(group) <= 30 and re.match(r'[a-zA-Z–∞-—è–ê-–Ø—ë–Å0-9_]', group) and group not in FORBIDDEN_NAMES:
            if group not in existing:
                groupsmgr.create_group(chat, group, sender)
                created.append(group)
            else:
                already_existed.append(group)
        else:
            bad_names.append(group)

    if peer > 2E9:
        name_data = cmd.vk.users.get(user_id=sender)[0]
        sender_name = name_data['first_name'] + ' ' + name_data['last_name']
        response = sender_name + '\n'
    else:
        response = ''

    if created:
        response += '–Ø –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–ª–∞ —ç—Ç–∏ –≥—Ä—É–ø–ø—ã: \n‚ûï '
        response += ' \n‚ûï '.join(created)
        response += ' \n'

    if already_existed:
        response += '–≠—Ç–∏ –≥—Ä—É–ø–ø—ã —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç: \n‚úî '
        response += ' \n‚úî '.join(already_existed)
        response += ' \n'

    if bad_names:
        response += '–ù–∞–∑–≤–∞–Ω–∏—è —ç—Ç–∏—Ö –≥—Ä—É–ø–ø –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º—ã: \nüö´ '
        response += ' \nüö´ '.join(bad_names)
        response += ' \n'

    cmd.send(peer, response)


def exec_delete(cmd, chat, peer, sender, args):
    """
    !—É–¥–∞–ª–∏—Ç—å
    """
    deleted = []
    not_found = []
    not_creator = []

    rank_user = groupsmgr.get_rank_user(chat, sender)
    existing = groupsmgr.get_all_groups(chat)
    sender_created_groups = groupsmgr.get_groups_created_user(chat, sender)

    for group in args:
        if group in existing:
            if group in sender_created_groups or rank_user > RANK_HOLOP:
                deleted.append(group)
                groupsmgr.delete_group(chat, group)
            else:
                not_creator.append(group)
        else:
            not_found.append(group)

    if peer > 2E9:
        name_data = cmd.vk.users.get(user_id=sender)[0]
        sender_name = name_data['first_name'] + ' ' + name_data['last_name']
        response = sender_name + '\n'
    else:
        response = ''

    if deleted:
        response += '–Ø —É–¥–∞–ª–∏–ª–∞ —ç—Ç–∏ –≥—Ä—É–ø–ø—ã: \n‚úñ '
        response += ' \n‚úñ '.join(deleted)
        response += ' \n'

    if not_found:
        response += '–≠—Ç–∏—Ö –≥—Ä—É–ø–ø –∏ —Ç–∞–∫ –Ω–µ—Ç –≤ –±–µ—Å–µ–¥–µ: \n‚õî '
        response += ' \n‚õî '.join(not_found)
        response += ' \n'

    if not_creator:
        response += '–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤, —á—Ç–æ–±—ã —É–¥–∞–ª–∏—Ç—å —ç—Ç–∏ –≥—Ä—É–ø–ø—ã: \nüö´ '
        response += ' \nüö´ '.join(not_creator)
        response += ' \n'

    cmd.send(peer, response)


def exec_join_group(cmd, chat, peer, sender, args):
    """
    !–ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è
    """
    joined = []
    already_joined = []  # –ø–µ—Ä–µ–∏–º–µ–Ω–Ω–æ–≤–∞—Ç—å
    not_found = []

    sender_groups = groupsmgr.get_user_groups(chat, sender)
    existing = groupsmgr.get_all_groups(chat)

    for group in args:
        if group in existing:
            if group not in sender_groups:
                joined.append(group)
                groupsmgr.join_group(chat, group, sender)
            else:
                already_joined.append(group)
        else:
            not_found.append(group)

    if peer > 2E9:
        name_data = cmd.vk.users.get(user_id=sender)[0]
        sender_name = name_data['first_name'] + ' ' + name_data['last_name']
        response = sender_name + '\n'
    else:
        response = ''

    if joined:
        response += '–î–æ–±–∞–≤–∏–ª–∞ –≤–∞—Å –≤ —ç—Ç–∏ –≥—Ä—É–ø–ø—ã: \n‚ûï '
        response += ' \n‚ûï '.join(joined)
        response += ' \n'

    if already_joined:
        response += '–í—ã —É–∂–µ —Å–æ—Å—Ç–æ–∏—Ç–µ –≤ —ç—Ç–∏—Ö –≥—Ä—É–ø–ø–∞—Ö: \n‚úî '
        response += ' \n‚úî '.join(already_joined)
        response += ' \n'

    if not_found:
        response += '–≠—Ç–∏ –≥—Ä—É–ø–ø—ã —è –Ω–µ –Ω–∞—à–ª–∞: \nüö´ '
        response += ' \nüö´ '.join(not_found)
        response += ' \n'

    cmd.send(peer, response)


def exec_left_group(cmd, chat, peer, sender, args):
    """
    !–æ—Ç–∫–ª—é—á–∏—Ç—å—Å—è
    """
    left = []
    already_left = []
    not_found = []

    sender_groups = groupsmgr.get_user_groups(chat, sender)
    existing = groupsmgr.get_all_groups(chat)

    for group in args:
        if group in existing:
            if group in sender_groups:
                left.append(group)
                groupsmgr.left_group(chat, group, sender)
            else:
                already_left.append(group)
        else:
            not_found.append(group)

    if peer > 2E9:
        name_data = cmd.vk.users.get(user_id=sender)[0]
        sender_name = name_data['first_name'] + ' ' + name_data['last_name']
        response = sender_name + '\n'
    else:
        response = ''

    if left:
        response += '–£—Å–ø–µ—à–Ω–æ –æ—Ç–∫–ª—é—á–∏–ª–∞ –≤–∞—Å –æ—Ç –≥—Ä—É–ø–ø: \n‚úñ '
        response += ' \n‚úñ '.join(left)
        response += ' \n'

    if already_left:
        response += '–í–∞—Å –∏ –Ω–µ –±—ã–ª–æ –≤ —ç—Ç–∏—Ö –≥—Ä—É–ø–ø–∞—Ö: \n‚õî '
        response += ' \n‚õî '.join(already_left)
        response += ' \n'

    if not_found:
        response += '–≠—Ç–∏ –≥—Ä—É–ø–ø—ã —è –Ω–µ –Ω–∞—à–ª–∞: \nüö´ '
        response += ' \nüö´ '.join(not_found)
        response += ' \n'

    cmd.send(peer, response)


def exec_join_member_group(cmd, chat, peer, sender, args):
    """
    !–ø–æ–¥–∫–ª—é—á–∏—Ç—å
    """
    rank_sender = groupsmgr.get_rank_user(chat, sender)
    if rank_sender == RANK_HOLOP:
        cmd.send(peer, "–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤")
        return
    if '>' not in args or args.count('>') > 1:
        cmd.print_usage(peer)
        return
    users = list(filter(re.compile(r'\[id+(\d+)\|\W*\w+\]').match, args[:args.index('>')]))
    groups = list(filter(re.compile(
        r'[a-zA-Z–∞-—è–ê-–Ø—ë–Å0-9_]').match,
                         args[args.index('>') + 1:] if len(args.count) - 1 > args.index('>') else []))
    if not users or not groups:
        cmd.print_usage(peer)
        return

    users = [int(user) for user in users]
    existing_groups = groupsmgr.get_all_groups(chat)
    existing_users = groupsmgr.get_all_users(chat)

    not_found = []
    joined = {}
    for user in users:
        if user in existing_users:
            joined.update({user: []})
            sender_groups = groupsmgr.get_user_groups(chat, user)
            for group in groups:
                if group in existing_groups and group not in sender_groups:
                    groupsmgr.join_group(chat, group, user)
                    joined[user].append(group)
            if not joined[user]:
                del joined[user]
        else:
            not_found.append(user)

    all_users_vk = cmd.vk.users.get(user_ids=users)
    first_names_joined = ""
    first_names_not_found = ""
    for user_vk in all_users_vk: # —Ö—Ä–µ–Ω –µ–≥–æ –∑–Ω–∞–µ—Ç, –º–± –ø–æ—Ç–æ–º –ø–µ—Ä–µ–¥–µ–ª–∞–µ–º
        if user_vk["id"] in joined:
            first_names_joined += "{0} > {1} \n".format("[id{0}|{1}]".format(str(user_vk["id"]), user_vk["first_name"]),
                                                     ' '.join(joined[user_vk["id"]]))
        if user_vk["id"] in not_found:
            first_names_not_found += "[id{0}|{1}] \n".format(str(user_vk["id"]), user_vk["first_name"])

    if peer > 2E9:
        name_data = cmd.vk.users.get(user_id=sender)[0]
        sender_name = name_data['first_name'] + ' ' + name_data['last_name']
        response = sender_name + '\n'
    else:
        response = ''

    if first_names_joined:
        response += first_names_joined

    if first_names_not_found:
        response += '–î–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–µ—Ç –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö: \n' + first_names_not_found

    if not first_names_not_found and not first_names_joined:
        response += '–ù–∏–∫—Ç–æ –Ω–∏–∫—É–¥–∞ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω'

    cmd.send(peer, response)


import re

import groupsmgr
import timetable

import vk_utils


# –ó–∞–ø—Ä–µ—â–µ–Ω–æ —Å–æ–∑–¥–∞–≤–∞—Ç—å –≥—Ä—É–ø–ø—ã —Å —ç—Ç–∏–º–∏ –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏.
FORBIDDEN_NAMES = ['all', '–≤—Å–µ', 'online', '–æ–Ω–ª–∞–π–Ω', '–∑–¥–µ—Å—å', 'here', '—Ç—É—Ç']


def exec_next_class(cmd, chat, peer, sender):
    """
    !–ø–∞—Ä–∞
    """
    sender_groups = groupsmgr.get_groups(cmd.chats, chat, sender)
    next_class = timetable.next_class(chat, sender_groups)

    if next_class is None:
        vk_utils.send(cmd.vk, peer, 'üö´ –ù–∞ —Å–µ–≥–æ–¥–Ω—è –≤—Å—ë. –ò–¥–∏ –ø–æ—Å–ø–∏, —á—Ç–æ –ª–∏.')
    else:
        class_data = next_class[0]
        time_left = timetable.time_left(next_class[1])
        vk_utils.send(cmd.vk, peer, 'üìö –°–ª–µ–¥—É—é—â–∞—è –ø–∞—Ä–∞: %s. –î–æ –Ω–∞—á–∞–ª–∞ %s.' % (class_data, time_left))


def exec_create(cmd, chat, peer, sender, args):
    """
    !—Å–æ–∑–¥–∞—Ç—å
    """
    print('create 1')
    existing = cmd.chats.distinct("groups.name", {"chat_id": chat})
    print('create 2')

    created = []
    bad_names = []
    already_existed = []

    print('create 3')

    for group in args:
        print('  ' + group)

        if 2 <= len(group) <= 30 and re.match(r'[a-zA-Z–∞-—è–ê-–Ø—ë–Å0-9_]', group) and group not in FORBIDDEN_NAMES:
            if group not in existing:
                print('  >> created')
                groupsmgr.create_group(chat, group, sender)
                created.append(group)
            else:
                print('  >> already exists')
                already_existed.append(group)
        else:
            print('  >> bad name')
            bad_names.append(group)

    print('create 4')

    if peer > 2E9:
        name_data = cmd.vk.users.get(user_id=sender)[0]
        sender_name = name_data['first_name'] + ' ' + name_data['last_name']
        response = sender_name + '\n'
    else:
        response = ''

    print('create 5')

    if created:
        response += '‚ûï –Ø –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–ª–∞ —ç—Ç–∏ –≥—Ä—É–ø–ø—ã:'

        for group in created:
            response += '- ' + group + '\n'

    print('create 6')

    if already_existed:
        response += '‚úî –≠—Ç–∏ –≥—Ä—É–ø–ø—ã —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç:'

        for group in already_existed:
            response += '- ' + group + '\n'

    print('create 7')

    if bad_names:
        response += 'üö´ –ù–∞–∑–≤–∞–Ω–∏—è —ç—Ç–∏—Ö –≥—Ä—É–ø–ø —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–µ –∏–ª–∏ —Å–æ–¥–µ—Ä–∂–∞—Ç –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–µ —Å–∏–º–≤–æ–ª—ã:'

        for group in bad_names:
            response += '- ' + group + '\n'

    print('create 8')

    vk_utils.send(cmd.vk, peer, response)

    print('create 9 END')
